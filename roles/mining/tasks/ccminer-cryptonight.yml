---
- name: Create directory for ccminer-cryptonight
  file: path=/home/mining/ccminer-cryptonight state=directory
        owner=mining group=mining mode=0770

- name: Install ccminer-cryptonight build dependencies
  apt: name="{{ item }}" state=present update_cache=yes cache_valid_time=3600
  with_items:
    - autoconf
    - autotools-dev
    - libcurl4-openssl-dev
    - libjansson-dev

- name: Checkout ccminer-cryptonight sources
  git:
    repo: 'https://github.com/KlausT/ccminer-cryptonight.git'
    dest: /home/mining/ccminer-cryptonight
    force: yes # autogen monkey's with sources in the repo, force the checkout so subsequent runs don't fail

- name: Setup ccminer sources (autogen.sh as raw commands)
  command: "{{ item }}"
  args:
    chdir: /home/mining/ccminer-cryptonight/
    creates: /home/mining/ccminer-cryptonight/Makefile
  environment:
    PATH: "/usr/local/cuda/bin:{{ ansible_env.PATH }}" # ensure nvcc will be found
  with_items:
    - aclocal
    - autoheader
    - automake --add-missing --gnu --copy
    - autoconf

- name: Build ccminer sources (this make take awhile)
  command: "{{ item }}"
  args:
    chdir: /home/mining/ccminer-cryptonight/ 
    creates: /home/mining/ccminer-cryptonight/ccminer
  environment:
    PATH: "/usr/local/cuda/bin:{{ ansible_env.PATH }}" # ensure nvcc will be found
  with_items:
  - ./configure
  - make -j{{ ansible_processor_cores }}

- name: Setup xmr-xdn script
  template: src=ccminer-xmr-xdn.j2 dest=/home/mining/ccminer-xmr-xdn.sh
            owner=mining group=mining mode=0550

- name: Setup ccminer-cryptonight service
  template: src=ccminer-cryptonight-service.j2 dest=/etc/systemd/system/ccminer-cryptonight.service
            owner=root group=root mode=0440
  when: mining_ccminer_cryptonight_service is defined and mining_ccminer_cryptonight_service

- name: Enable ccminer-cryptonight service
  service: name=ccminer-cryptonight.service enabled=yes
  when: mining_ccminer_cryptonight_service is defined and mining_ccminer_cryptonight_service
